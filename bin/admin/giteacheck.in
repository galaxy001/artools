#!/bin/bash
#
# Copyright (C) 2018-21 artoo@artixlinux.org
# Copyright (C) 2021 Artix Linux Developers
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

m4_include(lib/util-base.sh)
m4_include(lib/util-pkg.sh)
m4_include(lib/base/message.sh)
m4_include(lib/pkg/common.sh)
m4_include(lib/admin/team.sh)

subrepos() {
    local subs
    subs=$(find "${TREE_DIR_ARTIX}/${GROUP}" -type f -name .gitrepo)
    echo "${subs[@]}"
}

get_team() {
    local p="$1" t
    if [[ -d "$p/$CARCH/core" ]]; then
        t=core
    elif [[ -d "$p/$CARCH/extra" ]]; then
        t=extra
    elif [[ -d "$p/$CARCH/community" ]]; then
        t=community
    elif [[ -d "$p/$CARCH/multilib" ]]; then
        t=multilib
    fi
    echo "$t"
}

run() {
    for r in $(subrepos); do
        local pkg=${r%/*} gitname org team
        team=$(get_team "$pkg")
        pkg=${name##*/}
        gitname=$(get_compliant_name "$pkg")
        org=$(get_pkg_org "$gitname")

        check_team "$org" "$gitname" "$team"
    done
}

load_makepkg_config

load_valid_names

usage() {
    echo "Usage: ${0##*/} [options]"
    echo '    -g <group>    Group name'
    echo '    -c            Check if a team is assigned to a repository'
    echo '    -h            This help'
    echo ''
    echo ''
    exit "$1"
}

check=false
GROUP=packages

opts='g:ch'

while getopts "${opts}" arg; do
    case "${arg}" in
        g) GROUP="$OPTARG" ;;
        c) check=true ;;
        h|?) usage 0 ;;
        *) echo "invalid argument '${arg}'"; usage 1 ;;
    esac
done

shift $(( OPTIND - 1 ))

run
